#!/usr/bin/env bash


function stopprocs () {
    ACTIVE_PROCS=$(ps ax | egrep "samba|smbd|nmbd|winbindd"|grep -v grep|cut -d/ -f4 |cut -d\  -f1|sort -u)
    
    for PROC in $ACTIVE_PROCS
    do
	case $PROC in
	    winbindd)
		sudo systemctl stop winbind
		;;
	    *mbd)
		sudo systemctl stop ${PROC}
		;;
	    samba)
		sudo systemctl stop samba-ad-dc
		;;
	    *)
		exit 1
		;;
	esac 
    done
}

function removeconf () {
    CONF=$(smbd -b | grep "CONFIGFILE" | cut -d: -f2|cut -d\  -f2)
    sudo rm /etc/krb5.conf
    sudo rm ${CONF}
}

function cleardirs () {
    SMBDIRS=$(smbd -b | egrep "LOCKDIR|STATEDIR|CACHEDIR|PRIVATE_DIR"|cut -d: -f2|cut -d\  -f2)

    for DIR in $SMBDIRS
    do
	cd $DIR
	sudo rm *.tdb *.ldb
    done
}

function createkrb5conf () {
    sudo cat << KRB5CONF > /etc/krb5.conf
[libdefaults] 
     default_realm = OLYMPUS.DERBER.HOME
     dns_lookup_realm = false 
     dns_lookup_kdc = true 
KRB5CONF
}

function createsmbconf () {
    sudo cat << SMBCONF > /etc/samba/smb.conf
#======================= Global Settings =======================

[global]
########## Domains ###########
[global]
netbios name = $(hostname| tr a-z A-Z)
workgroup = OLYMPUS
realm = OLYMPUS.DERBER.HOME

security = ADS

# Logging
max log size = 1000
log file = /var/log/samba/log.%m
log level = 1 passdb:10 winbind:10 idmap:10


######## User Settings #######
username map = /etc/samba/users.map
# idmap config for ...
idmap config * : backend = tdb
idmap config * : range = 3000-7999
# idmap config for Olympus domain
idmap config OLYMPUS : backend = ad
idmap config OLYMPUS : schema_mode = rfc2307
idmap config OLYMPUS : range = 10000-999999
idmap config OLYMPUS : unix_nss_info = yes
idmap config OLYMPUS : unix_primary_group = yes

######## Winbind ###########
# template shell = /bin/bash
# template home = /home/%U
winbind trusted domains only = no
winbind use default domain = yes
winbind enum users = yes
winbind enum groups = yes
winbind refresh tickets = Yes 

####### Enable ACL Support ######
vfs objects = acl_xattr
map acl inherit = yes
store dos attributes = yes

dedicated keytab file = /etc/krb5.keytab
kerberos method = secrets and keytab

#[netlogon]
#        path = /var/lib/samba/sysvol/olympus.home/scripts
#        read only = No

[sysvol]
        path = /var/lib/samba/sysvol
        read only = No

SMBCONF

}

function verifyhost () {
    HOSTSLINE="$(grep $(hostname|tr A-Z a-z) /etc/hosts)"
    HOSTSIP=$(echo "${HOSTSLINE}"|cut -d\  -f1)
    if [[ ! "${HOSTIP}" =~ "192" ]]; then
    echo "Edit hosts"
	exit 1
    fi
    GETENT="$(getent hosts $(hostname))"
    echo ${HOSTSLINE}
    echo ${GETENT}
    if [[ ${HOSTSLINE} == ${GETENT} ]]; then
	echo "Getent successful"
    else
	echo "Getent failed"
    fi
    
    
}

function createusermap () {
    sudo cat << USERMAP > /etc/samba/users.map
!root = OLYMPUS\Administrator
USERMAP
}

function joindomain () {
    net ads join -U administrator
}

function startservice () {
    sudo systemctl start winbind
    sudo systemctl start nmbd
}

verifysetup () {
    wbinfo --ping-dc
    getent passwd
    getent group
}

function installsmb () {
    apt install samba libnss-winbind libpam-winbind krb5-user libpam-krb5
}

function main() {
    #installsmb
    stopprocs
    removeconf
    cleardirs
    #createkrb5conf
    #verifyhost
    #createusermap
    #createsmbconf
    #joindomain
    #startservice
    #verifysetup
}

main $@
