#!/bin/bash
# ======================
#
# Nightly
#
# ....
#
# ================
CURL=$(command -v curl)
SH=$(command -v sh)
GRIVE=$(command -v grive)
ONEDRIVE=$(command -v onedrive)
GIT=$(command -v git)
FETCH="$(${GIT} fetch --all)"
PULL="$(${GIT} pull --all)"
DOTFILESSH_URL=https://gderber.github.io/dotfiles.sh
GDRIVE_DIR=${HOME}/GDrive
ONEDRIVE_DIR=${HOME}/Onedrive

function __help () {
    cat << HELP
...
HELP
}

function systemupdate () {
    cd /usr/local/src
    for DIR in $(ls -d *)
    do
	cd $DIR
	# if git repo ...
	${PULL}
	make install
    done
}

function userupdate () {
    local SEED=$(head -1 /dev/urandom | od -N 1 | awk '{ print $2 }'| sed s/^0*//)
    local RANDOM=$SEED # Reseed the random number generator
    local WAIT
    let "WAIT=${RANDOM} % 60"

    sleep ${WAIT}s
    ${CURL} ${DOTFILESSH_URL} | ${SH}

    if [[ -d ${GDRIVE_DIR} ]]; then
	RALDON=${SEED}
	let "WAIT=${RANDOM} % 60"
	sleep ${WAIT}s
	cd ${GDRIVE_DIR}
	${GRIVE}
    fi
    if [[ -d ${ONEDRIVE_DIR} ]]; then
	RALDON=${SEED}
	let "WAIT=${RANDOM} % 60"
	sleep ${WAIT}s
	${ONEDRIVE}
    fi    
}

function main () {
    while [[ -n $1 ]]
    do
	case $1 in
	    -s|--system)
		SYSTEM=true
		shift 1
		;;
	    -h|--help)
		__help
		exit
		;;
	    *)
		__help
		exit 1
		;;
	esac
    done

    if [[ "${SYSTEM}" == "true" ]]; then
       systemupdate
    fi
    userupdate
}

main $@
